---
title: "CodeRabbit QA Review - 2025-11-02_13-22-45"
link: "cr-qa-2025-11-02_13-22-45"
type: "qa"
tags:
  - code-review
  - coderabbit
  - security
  - eval-usage
created_at: "2025-11-02_13-22-45"
updated_at: "2025-11-02_13-22-45"
uuid: "c7348078-87a7-4c21-bc4c-24584a5b7b03"
---

# CodeRabbit QA Review - 2025-11-02

## Summary

CodeRabbit identified 1 security issue in the codebase related to the use of `eval()` in test code.

## Issues Found

### 1. Security Issue: Unsafe eval() Usage

**File**: `tests/prompt_test/test_code_agent.py`
**Lines**: 10-13
**Type**: potential_issue
**Severity**: Security Risk

**Description**:
The `calculator_tool` function uses `eval()` which is a security risk, even in test code. This sets a bad example that could be copied elsewhere and violates security best practices.

**Current Code**:
```python
@tool
def calculator_tool(expression: str) -> float:
    """Simple calculator tool."""
    return eval(expression)  # Note: eval is dangerous but acceptable for testing
```

**Recommended Fix**:
Replace `eval()` with a safer alternative using AST parsing and validation. Options:

1. **AST-based safe evaluator** (recommended for complex expressions):
   - Parse expression into AST using `ast.parse()`
   - Validate only allowed node types (Num/Constant, BinOp, UnaryOp, supported operators)
   - Evaluate by walking AST with operator mapping
   - No `eval()` calls

2. **ast.literal_eval()** (for simple literal expressions):
   - Only if test expressions are trivial literals
   - Limited functionality but very safe

**CodeRabbit Suggested Code**:
```python
@tool
def calculator_tool(expression: str) -> float:
    """Simple calculator tool."""
    import ast
    import operator

    # Safe evaluation of basic arithmetic expressions
    ops = {
        ast.Add: operator.add,
        ast.Sub: operator.sub,
        ast.Mult: operator.mul,
        ast.Div: operator.truediv,
    }

    def eval_expr(node):
        if isinstance(node, ast.Num):
            return node.n
        elif isinstance(node, ast.BinOp):
            return ops[type(node.op)](eval_expr(node.left), eval_expr(node.right))
        else:
            raise ValueError(f"Unsupported operation: {node}")

    return eval_expr(ast.parse(expression, mode='eval').body)
```

## Action Items

- [x] Replace `eval()` with safe AST-based evaluator in `tests/prompt_test/test_code_agent.py:10-13`
- [x] Add proper error handling for invalid/unsafe expressions
- [x] Ensure all necessary imports are added
- [x] Run tests to verify functionality is maintained
- [x] Fix additional `eval()` in `examples/file_prompt_demo.py`
- [x] Fix MyPy duplicate module configuration issue
- [x] Run pre-commit hooks to ensure code quality

## Implementation Details

### Files Modified

1. **tests/prompt_test/test_code_agent.py** (lines 10-52)
   - Replaced unsafe `eval()` with AST-based safe evaluator
   - Added support for operators: Add, Sub, Mult, Div, Pow, Mod, USub (unary negation)
   - Handles both Python 3.8+ (ast.Constant) and 3.7 (ast.Num) for compatibility
   - Comprehensive error handling for invalid/unsafe expressions
   - Returns float for consistency with original function

2. **examples/file_prompt_demo.py** (lines 17-59)
   - Applied same safe evaluator implementation
   - Ensures example code follows security best practices
   - Prevents users from copying insecure eval() pattern

3. **.pre-commit-config.yaml** (line 35)
   - Added `--explicit-package-bases` flag to mypy args
   - Fixes duplicate module name error between `tests/api_test/test_code_agent.py` and `tests/prompt_test/test_code_agent.py`

### Implementation Approach

The safe evaluator:
- Parses expressions into an Abstract Syntax Tree (AST)
- Validates that only allowed node types are present (Constant/Num, BinOp, UnaryOp)
- Evaluates expressions by walking the AST and applying operator mappings
- Rejects any unsupported operations or expressions
- Never calls `eval()` or `exec()`

### Test Results

All tests pass successfully:
```
============================= test session starts ==============================
tests/prompt_test/test_code_agent.py::TestTinyCodeAgentWithPromptFile::test_code_agent_with_custom_prompt_file PASSED [ 12%]
tests/prompt_test/test_code_agent.py::TestTinyCodeAgentWithPromptFile::test_code_agent_with_missing_prompt_file PASSED [ 25%]
tests/prompt_test/test_code_agent.py::TestTinyCodeAgentWithPromptFile::test_code_agent_with_system_suffix_and_prompt_file PASSED [ 37%]
tests/prompt_test/test_code_agent.py::TestTinyCodeAgentWithPromptFile::test_code_agent_without_prompt_file PASSED [ 50%]
tests/prompt_test/test_code_agent.py::TestTinyCodeAgentWithPromptFile::test_code_agent_with_empty_prompt_file PASSED [ 62%]
tests/prompt_test/test_code_agent.py::TestTinyCodeAgentWithPromptFile::test_code_agent_with_markdown_prompt_file PASSED [ 75%]
tests/prompt_test/test_code_agent.py::TestTinyCodeAgentWithPromptFile::test_code_agent_prompt_file_none_parameter PASSED [ 87%]
tests/prompt_test/test_code_agent.py::TestTinyCodeAgentWithPromptFile::test_code_agent_with_extra_imports_and_prompt_file PASSED [100%]

============================== 8 passed in 0.89s
```

### Pre-commit Validation

All pre-commit hooks pass:
- ✅ ruff (linting)
- ✅ ruff-format (formatting)
- ✅ trim trailing whitespace
- ✅ fix end of files
- ✅ check yaml
- ✅ check for added large files
- ✅ check json
- ✅ check toml
- ✅ check for merge conflicts
- ✅ check for case conflicts
- ✅ detect private key
- ✅ bandit (security scanning - no eval() warnings)
- ✅ mypy (type checking - no duplicate module errors)
- ✅ Check Python file line count
- ✅ Check Python naming conventions

## Fix Status

**Status: ✅ COMPLETED**

All CodeRabbit-identified security issues have been successfully resolved. The codebase now uses safe AST-based expression evaluation instead of `eval()`, and all tests and pre-commit hooks pass.
