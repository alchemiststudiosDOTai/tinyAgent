---
title: Local Code Executor
path: execution/local.py
type: file
depth: 1
description: Sandboxed Python code execution in restricted process environment
exports: [LocalExecutor, SAFE_BUILTINS]
seams: [M]
---

# execution/local.py

## Where
`/Users/tuna/tinyAgent/tinyagent/execution/local.py`

## What
Provides `LocalExecutor` class for executing Python code in sandboxed, restricted environment within the same process. Limits access to system resources while capturing output and enforcing execution limits.

## How

### Key Classes

**LocalExecutor**
Central class for restricted code execution:

**Initialization:**
- `__init__(allowed_imports, limits)`: Sets up allowed imports and execution limits
- `_reset_namespace()`: Prepares restricted `__builtins__` using SAFE_BUILTINS
- Injects `_safe_import` function and `final_answer` function

**Core Methods:**
- `run(code)`: Execute Python code string
  - Validates imports via `_check_imports`
  - Executes using `exec()` in controlled namespace
  - Captures stdout via `io.StringIO`
  - Applies timeout limits
  - Returns `ExecutionResult`
- `inject(name, value)`: Add external values to execution namespace
- `_safe_import(...)`: Custom `__import__` function
  - Checks if module in `_allowed_imports` set
  - Raises ImportError if not allowed
- `_final_answer(value, verified_by)`: Injected function for signaling final answer
- `_check_imports(code)`: AST-based static analysis
  - Parses code into Abstract Syntax Tree
  - Prevents unauthorized imports before execution
  - Raises RuntimeError if disallowed imports found

**FinalResult (Class)**
Sentinel class wrapping value passed to `final_answer` function

**Security Features:**
- `SAFE_BUILTINS`: Whitelist of safe built-in functions
- Import control via `_safe_import` and AST checking
- No access to `open`, `exit`, or other dangerous builtins

## Why

**Design Rationale:**
- **exec() Control**: Fine-grained control over namespace and builtins
- **Sandboxing**: Restricted builtins and import control for isolation
- **Timeout**: `ExecutionLimits` integration prevents infinite loops
- **Output Capture**: `io.StringIO` captures stdout without interference
- **Balance**: Isolation vs performance for trusted code

**Architectural Role:**
- **Agent Execution**: Runs code generated by agents or defined as tools
- **Safety Mechanism**: Ensures actions don't harm host system
- **Integration**: Works with `ExecutionLimits` and returns `ExecutionResult`
- Crucial execution engine for agent operations

**Dependencies:**
- `execution.protocol.ExecutionResult`: Result structure
- `limits.ExecutionLimits`: Resource constraints
- `ast`: Static analysis for import checking
- `inspect`: Code inspection
- `io`: Output capture
- `contextlib`: Stdout redirection
