---
id: kap-1103
status: closed
deps: []
links: [kap-ac21]
created: 2026-02-01T18:32:14Z
type: epic
priority: 1
---
# Mypy cleanup: proxy types + message TypedDict migration

Fix remaining mypy errors without casts/ignores.\n\nScope:\n- Clean proxy_types import fallback and type aliases\n- Convert message/content types (Text/Image/Thinking/ToolCall/User/Assistant/ToolResult) to TypedDict with streaming optional fields\n- Update message constructors to dict literals (agent_tool_execution, openrouter_provider, agent.py, proxy.py)\n- Align proxy_event_handlers content list typing and event TypedDict fields\n- Tighten agent_loop/agent.py return types + callback signatures\n- Verify mypy (lint_file_length.py only)

## Acceptance Criteria

mypy *.py --ignore-missing-imports reports only lint_file_length.py errors


## Notes

**2026-02-01T18:36:49Z**

Plan (clean fixes, no ignores/casts):
1) proxy_types.py: wrap imports under TYPE_CHECKING to avoid redefinition; define StopReason/AssistantMessageEvent/SimpleStreamOptions as TypeAlias once; runtime fallback in else/try-except; keep ToolCall alias.
2) Convert message/content types to TypedDict: TextContent, ImageContent, ThinkingContent (new), ToolCallContent (optional partialJson), UserMessage, AssistantMessage, ToolResultMessage, CustomAgentMessage. Define ContentBlock = TextContent | ThinkingContent | ToolCallContent; AssistantMessage.content uses ContentBlock list.
3) Update dict-style creators/consumers: openrouter_provider builds dict blocks and checks part["type"]; agent_tool_execution uses dict access for tool calls; proxy_event_handlers uses placeholder TextContent in _ensure_content_slot, typed helpers for text/thinking; tighten event_type params to Literal; parseStreamingJson returns dict only; guard event_type is str.
4) agent_loop: make streamSimple async returning StreamResponse; ensure streamFunction typed as StreamFn; fix no-any-return in handlers.
5) agent.py: AgentOptions.initial_state -> AgentState | None; default_convert_to_llm narrows by role; _has_meaningful_content uses _get_attr; use AgentEndEvent dataclass on error emit; bool() for abort flag.
6) proxy.py: _parse_sse_data returns dict[str, Any] | None via isinstance check.
Acceptance: mypy *.py --ignore-missing-imports reports only lint_file_length.py errors.

**2026-02-01T19:15:27Z**

Mypy check now reports only lint_file_length.py errors (3). Stream/message types converted to TypedDict; proxy_types fallback cleaned; handlers updated.
